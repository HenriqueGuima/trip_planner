<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Planner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Flatpickr for date range selection -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        /* Page base */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: #f5f7fb; color: #1f2937; }

        /* Layout */
        #map { height: calc(100vh - 56px); min-height: 360px; border-radius: .5rem; box-shadow: 0 6px 24px rgba(16,24,40,0.08); }
        .trips-column { max-height: calc(100vh - 120px); overflow-y: auto; padding-right: 8px; }
        .sidebar-card { background: linear-gradient(180deg,#ffffff 0%, #fbfdff 100%); border: 0; border-radius: .75rem; box-shadow: 0 8px 30px rgba(16,24,40,0.06); }

        /* Add Trip modern form */
        .modern-add-card .input-group-text { background: transparent; border-right: 0; }
        .modern-add-card .form-control { border-left: 0; }
        .modern-add-card .btn { border-radius: .5rem; }

        /* Trip list */
        .trip-list { display: flex; flex-direction: column; gap: .75rem; padding: 0; margin: 0; }
        .trip-card { display: flex; gap: 1rem; align-items: center; justify-content: space-between; padding: .9rem; border-radius: .65rem; background: #fff; box-shadow: 0 4px 18px rgba(16,24,40,0.04); transition: transform .12s ease, box-shadow .12s ease; }
        .trip-card:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(16,24,40,0.06); }
        .trip-info { flex: 1 1 auto; min-width: 0; }
        .trip-destination { font-weight: 600; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .trip-meta { color: #6c757d; font-size: .85rem; display: flex; gap: .5rem; align-items: center; margin-top: .25rem; flex-wrap: wrap; }
        .trip-datetime { color: #0d6efd; font-weight: 600; font-size: .9rem; }
        .trip-actions { display: flex; gap: .5rem; align-items: center; }
        .no-trips { color: #6c757d; padding: .5rem 0; }

        /* Responsive tweaks */
        @media (max-width: 767px) {
            #map { height: 50vh; }
            .trips-column { max-height: none; }
        }
    </style>
    <style>
        /* Custom InfoWindow visuals for Google Maps markers */
        .gm-style-iw {
            /* override Google max-width and use a fixed modern card size */
            max-width: none !important;
            width: 380px !important;
            border-radius: 12px !important;
            box-shadow: 0 10px 40px rgba(16,24,40,0.12) !important;
            overflow: visible !important;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }
        .gm-style-iw .gm-style-iw-chr,
        .gm-style-iw .gm-style-iw-ch {
            border-radius: 12px !important;
            overflow: hidden !important;
        }
        .gm-style-iw .gm-style-iw-d {
            /* fixed height with scroll inside */
            max-height: none !important;
            height: 420px !important;
            overflow: auto !important;
            padding: 12px !important;
            background: linear-gradient(180deg,#ffffff 0%, #fbfdff 100%) !important;
            color: #111827 !important;
        }
    /* Image styling inside info window */
    .gm-style-iw img { display:block; width:100%; height:120px; object-fit:cover; border-radius:8px; margin-bottom:10px; }
        .gm-style-iw h5 { margin:4px 0 6px 0; font-size:1.05rem; font-weight:600; }
        .gm-style-iw a { color: #0d6efd; text-decoration: none; }
        .gm-style-iw .secondary { color:#6c757d; margin-top:8px; font-size:0.9rem; }
        .gm-style-iw .no-trips { margin-top:10px; color:#6c757d; font-style:italic; }
        /* Style the close button so it sits above the card */
        .gm-style-iw > .gm-style-iw-chr > button.gm-ui-hover-effect,
        .gm-style-iw > button.gm-ui-hover-effect {
            position: absolute !important;
            top: 8px !important;
            right: 8px !important;
            background: rgba(255,255,255,0.95) !important;
            border-radius: 50% !important;
            width: 40px !important;
            height: 40px !important;
            box-shadow: 0 6px 18px rgba(16,24,40,0.08) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border: 0 !important;
        }
        .gm-style-iw > .gm-style-iw-chr > button.gm-ui-hover-effect span,
        .gm-style-iw > button.gm-ui-hover-effect span {
            width: 20px !important;
            height: 20px !important;
            display: block !important;
            mask-size: contain !important;
            background: #0f1724 !important;
            opacity: 0.9 !important;
        }
        /* Make sure scrollbars don't overflow the rounded corners on some browsers */
        .gm-style-iw .gm-style-iw-d::-webkit-scrollbar { width: 8px; }
        .gm-style-iw .gm-style-iw-d::-webkit-scrollbar-thumb { background: rgba(16,24,40,0.06); border-radius: 8px; }
    </style>
</head>
<body class="p-3">
<div class="container-fluid">
    <div class="row">
        <!-- Left column: controls (Add Trip + Date filter) -->
        <div class="col-md-3">
            <h1 class="mb-4">Trip Planner</h1>

            <!-- Add Trip -->
            <div class="sidebar-card p-3 mb-3 modern-add-card">
                <div class="mb-3">
                    <label for="home" class="form-label">From</label>
                    <input type="text" id="home" class="form-control" placeholder="Start address or place">
                </div>
                <div class="row g-2 align-items-center">
                    <div class="col-8">
                        <label for="destination" class="form-label visually-hidden">To</label>
                        <div class="input-group">
                            <span class="input-group-text">To</span>
                            <input type="text" id="destination" class="form-control" placeholder="Destination">
                            <button id="swapPlacesBtn" class="btn btn-outline-secondary" type="button" title="Swap home and destination">⇄</button>
                        </div>
                    </div>
                    <div class="col-4">
                        <label for="datetime" class="form-label visually-hidden">Date/time</label>
                        <input type="text" id="datetime" class="form-control" placeholder="YYYY-MM-DD HH:MM" readonly>
                    </div>
                </div>
                <div class="mt-3 d-grid">
                    <button id="addBtn" class="btn btn-primary">Add Trip</button>
                </div>
            </div>

            <!-- Date Range Filter -->
            <div class="mb-3">
                <label for="dateRange" class="form-label">Filter by Date Range</label>
                <div class="input-group">
                    <input type="text" id="dateRange" class="form-control" placeholder="Select date range" readonly>
                    <button id="clearRange" class="btn btn-outline-secondary" type="button">Clear</button>
                </div>
            </div>

            <!-- Place filters -->
            <div id="filters" class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="fw-semibold">Places</div>
                    <div>
                        <button id="filtersSelectAll" class="btn btn-sm btn-outline-primary">Select All</button>
                    </div>
                </div>
                <div class="mb-2">
                    <input id="filterSearch" class="form-control form-control-sm" placeholder="Search place types (e.g. bar, museum)">
                </div>
                <div id="filterPills" class="d-flex flex-wrap gap-2">
                    <input type="checkbox" class="btn-check place-filter" id="pf-bar" autocomplete="off" value="bar" checked>
                    <label class="btn btn-outline-secondary btn-sm" for="pf-bar">Bars</label>

                    <input type="checkbox" class="btn-check place-filter" id="pf-sauna" autocomplete="off" value="sauna" checked>
                    <label class="btn btn-outline-secondary btn-sm" for="pf-sauna">Saunas</label>

                    <input type="checkbox" class="btn-check place-filter" id="pf-museum" autocomplete="off" value="museum" checked>
                    <label class="btn btn-outline-secondary btn-sm" for="pf-museum">Cultural</label>

                    <input type="checkbox" class="btn-check place-filter" id="pf-vegan" autocomplete="off" value="vegan restaurant" checked>
                    <label class="btn btn-outline-secondary btn-sm" for="pf-vegan">Vegan Restaurants</label>
                </div>
            </div>
        </div>

        <!-- Center column: map -->
        <div class="col-md-6">
            <div id="map" class="mb-4"></div>
            <div id="mapsError" style="display:none;margin-top:12px" class="alert alert-warning">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <strong>Map loading blocked.</strong>
                    <button id="mapsErrorDismiss" class="btn btn-sm btn-outline-secondary">Dismiss</button>
                </div>
                <div style="margin-top:6px">The Google Maps script or a network request (e.g. <code>gen_204</code>) was blocked — this often happens when an ad‑blocker or privacy extension blocks requests to Google domains. Try disabling extensions for this site, whitelisting <code>maps.googleapis.com</code>, or opening the page in an incognito window with extensions disabled.</div>
                <div id="mapsErrorDetails" style="margin-top:8px;font-size:0.9rem;color:#333;word-break:break-word"></div>
            </div>
        </div>

        <!-- Right column: trip list -->
        <div class="col-md-3 trips-column">
            <div id="tripList" class="trip-list"></div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Trip</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <div class="mb-3">
                    <label>Home</label>
                    <input type="text" id="editHome" class="form-control">
                </div>
                <div class="mb-3">
                    <label>Destination</label>
                    <input type="text" id="editDestination" class="form-control">
                </div>
                <div class="mb-3">
                    <label>Date/Time</label>
                    <input type="text" id="editDatetime" class="form-control" placeholder="YYYY-MM-DD HH:MM" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="saveEditBtn" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Flatpickr (date range picker) -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="./app.js"></script>
<script src="./maps.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Load app config (gitignored) so API keys are not inlined into index.html -->
<script src="./config.js"></script>
<!-- Load Google Maps lazily and asynchronously (best-practice wrapper) -->
<script>
    (function loadGoogleMaps() {
        if (window.google && window.google.maps) return; 
        const key = (window.APP_CONFIG && window.APP_CONFIG.GOOGLE_MAPS_KEY) || '';
        const url = `https://maps.googleapis.com/maps/api/js?key=${key}&libraries=places&callback=initMap`;
        const s = document.createElement('script');
        s.src = url;
        s.async = true;
        s.defer = true;
        s.setAttribute('loading', 'lazy');
        s.onerror = function(e) {
            console.error('Failed to load Google Maps API', e);
            const el = document.getElementById('mapsError'); if (el) el.style.display = 'block';
            const details = document.getElementById('mapsErrorDetails');
            if (details) details.textContent = `Failed script load: ${s.src}\nReferrer: ${document.referrer || location.href}\nUser-Agent: ${navigator.userAgent}`;
        };
        document.head.appendChild(s);
    })();
    // Listen for blocked requests or CSP/network errors that commonly show as gen_204 failures
    window.addEventListener('error', (ev) => {
        try {
            const src = ev?.filename || ev?.target?.src || '';
            if (src && src.includes('maps.googleapis.com')) {
                const el = document.getElementById('mapsError'); if (el) el.style.display = 'block';
                const details = document.getElementById('mapsErrorDetails');
                if (details) details.textContent = `Blocked resource: ${src}\nReferrer: ${document.referrer || location.href}\nUser-Agent: ${navigator.userAgent}`;
            }
        } catch (e) {}
    }, true);
    document.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('mapsErrorDismiss');
        if (btn) btn.addEventListener('click', () => {
            const el = document.getElementById('mapsError'); if (el) el.style.display = 'none';
        });
    });
</script>
</body>
</html>

